<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Asbest Tool ‚Äî User</title>
<style>
  :root{--bg:#0f1320;--panel:#151a2c;--panel2:#101528;--muted:#8a93a2;--text:#e8ecf6;--border:#262c45;--accent:#6ea8fe;}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  body{margin:0;background:#0f1320;color:var(--text)}
  a{color:var(--accent);text-decoration:none;cursor:pointer}
  .app{display:grid;grid-template-columns:230px 1fr;min-height:100vh}
  .sidebar{background:#0b1020;border-right:1px solid var(--border);padding:16px;position:sticky;top:0;height:100vh}
  .brand{display:flex;align-items:center;gap:10px;margin-bottom:16px}
  .logo{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,#6ea8fe,#8f7afe)}
  .tenant{font-size:12px;color:var(--muted);margin-top:2px}
  .nav a{display:block;padding:10px 12px;margin:4px 0;border-radius:8px;color:#cfd6ea}
  .nav a:hover{background:#1b2240}
  .nav a.active{background:#1b2240;color:#fff;border:1px solid var(--border)}
  .content{padding:14px}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .crumbs{font-size:12px;color:var(--muted)}
  .btn{padding:7px 9px;border:1px solid var(--border);border-radius:8px;background:#151a2c;color:#fff;cursor:pointer;font-size:14px}
  .btn:hover{background:#1b2240}
  .btn.primary{background:#2b63ff;border-color:#2b63ff}
  .btn.ghost{background:transparent}
  .card{background:#151a2c;border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px}
  .card h3{margin:0 0 8px;font-size:16px}
  .muted{color:var(--muted);font-size:12px}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#121733;font-size:12px;color:#cdd4ea}
  .chip.ok{background:#15251a;color:#b7f7c9;border-color:#224a2f}
  .chip.warn{background:#2c250f;color:#ffe28a;border-color:#5c4f19}
  .chip.bad{background:#2b1414;color:#ffb1b1;border-color:#6a2a2a}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th{padding:6px 10px;text-align:left;color:var(--muted);font-size:12px}
  td{background:#101528;border:1px solid var(--border);padding:10px;border-radius:10px;font-size:14px}
  .uploader{border:2px dashed var(--border);border-radius:12px;padding:22px;text-align:center;background:#0b1020}
  .progress{height:8px;background:#0b1020;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-top:10px}
  .bar{height:100%;width:0;background:#2b63ff}
  .json{background:#0b1020;border:1px dashed var(--border);border-radius:10px;padding:12px;font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre-wrap}
  .icon-btn{border:none;background:none;cursor:pointer;color:#e8ecf6;font-size:16px;padding:4px}
  .icon-btn:hover{color:#6ea8fe}
  /* Globale form-styling voor √°lle schermen (User, Tenant Admin, System Owner) */
  input[type="text"],
  input[type="email"],
  input[type="password"],
  input[type="number"],
  input[type="search"],
  select,
  textarea{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid var(--border);
    background:#0d1224;
    color:#e9edfa;
    outline:none;
  }
  input:disabled, select:disabled, textarea:disabled{
    opacity:.7;
    color:#9aa3bf;
    background:#0f1328;
  }
  input::placeholder, textarea::placeholder{ color: var(--muted); }
  input:focus, select:focus, textarea:focus{
    border-color:#6ea8fe;
    box-shadow:0 0 0 3px rgba(110,168,254,.15);
  }
  label{ display:block; margin:6px 0 6px; color:var(--muted); font-size:12px; }
  
  /* Slice 6: Toast animations */
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  /* Findings Panel Styles */
  .findings-drawer {
    position: fixed;
    top: 0;
    right: 0;
    width: 600px;
    height: 100vh;
    background: var(--panel);
    border-left: 1px solid var(--border);
    z-index: 1000;
    display: flex;
    flex-direction: column;
  }
  
  .findings-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .findings-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }
  
  .findings-report-id {
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }
  
  .close-btn {
    border: none;
    background: none;
    cursor: pointer;
    color: var(--text);
    font-size: 18px;
    padding: 4px;
  }
  
  .close-btn:hover {
    color: var(--accent);
  }
  
  .findings-controls {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 12px;
    align-items: center;
  }
  
  .score-badge {
    padding: 6px 10px;
    border-radius: 8px;
    background: #eef2ff;
    color: #3730a3;
    font-weight: 700;
    font-size: 14px;
  }
  
  .findings-search {
    margin-left: auto;
    width: 220px;
  }
  
  .severity-filters {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 8px;
  }
  
  .severity-chip {
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--panel2);
    color: var(--text);
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
  }
  
  .severity-chip.active {
    background: #eef2ff;
    color: #3730a3;
    border-color: #3730a3;
  }
  
  .findings-content {
    flex: 1;
    overflow: auto;
  }
  
  .findings-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .findings-table th {
    padding: 10px 12px;
    text-align: left;
    background: var(--panel2);
    color: var(--muted);
    font-size: 12px;
    font-weight: 600;
  }
  
  .findings-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    color: var(--text);
  }
  
  .severity-badge {
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 700;
  }
  
  .severity-low { background: #ecfdf5; color: #065f46; }
  .severity-medium { background: #fffbeb; color: #92400e; }
  .severity-high { background: #fef3c7; color: #92400e; }
  .severity-critical { background: #fee2e2; color: #991b1b; }
</style>
<script>
  // API Configuration - PAS DIT AAN NAAR JE RAILWAY URL
  const API_BASE_URL = 'https://v2asbest-tool-production.up.railway.app';
  
  const CURRENT_USER = { firstName: 'S.', lastName: 'Jansen', full: 'S. Jansen' };

  // API Helper Functions
  async function apiCall(endpoint, options = {}) {
    const url = `${API_BASE_URL}${endpoint}`;
    const token = localStorage.getItem('asbest_jwt');
    
    const config = {
      headers: {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` }),
        ...options.headers
      },
      ...options
    };
    
    try {
      const response = await fetch(url, config);
      if (response.status === 401) {
        // Unauthorized - redirect to login
        localStorage.removeItem('asbest_jwt');
        window.location.href = '/auth';
        return;
      }
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return await response.json();
    } catch (error) {
      console.error('API Error:', error);
      throw error;
    }
  }

  // Health Check
  async function checkApiHealth() {
    try {
      const health = await apiCall('/healthz');
      console.log('API Health:', health);
      return health.status === 'healthy';
    } catch (error) {
      console.error('API Health Check Failed:', error);
      return false;
    }
  }

  // Load Reports (User can only see own tenant reports)
  async function loadReports() {
    try {
      const data = await apiCall('/reports/');
      console.log('Reports loaded:', data);
      updateReportsTable(data.items || []);
      return data.items || [];
    } catch (error) {
      console.error('Failed to load reports:', error);
      return [];
    }
  }

  // Update reports table with real data
  function updateReportsTable(reports) {
    const tbody = document.querySelector('table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    reports.forEach(report => {
      const row = document.createElement('tr');
      
      // Status chip
      let statusChip = '';
      if (report.status === 'DONE') {
        statusChip = '<span class="chip ok">Done</span>';
      } else if (report.status === 'PROCESSING') {
        statusChip = '<span class="chip warn">Processing</span><div class="progress" style="margin-top:6px;height:4px"><div class="bar" style="width:40%"></div></div>';
      } else if (report.status === 'FAILED') {
        statusChip = '<span class="chip bad">Failed</span>';
      } else {
        statusChip = '<span class="chip">' + report.status + '</span>';
      }
      
      // Format date
      const uploadDate = new Date(report.uploaded_at).toLocaleDateString('nl-NL', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      row.innerHTML = `
        <td><a onclick="showReportDetail('${report.id}')">${report.filename}</a></td>
        <td>${statusChip}</td>
        <td>${report.finding_count || '‚Äî'}</td>
        <td>${report.score || '‚Äî'}</td>
        <td>${uploadDate}</td>
        <td>
          <button class="icon-btn" title="Bekijk" onclick="showReportDetail('${report.id}')">üëÅ</button>
          <button class="icon-btn" title="Download rapport" onclick="downloadSource('${report.id}')">‚¨áÔ∏è</button>
          <button class="icon-btn" title="Download conclusie & aanbevelingen (PDF)" onclick="downloadConclusion('${report.id}')" ${report.status !== 'DONE' ? 'disabled' : ''}>üìù</button>
          <button class="icon-btn" title="Verwijder" onclick="confirmDelete('${report.id}')">üóëÔ∏è</button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  }

  // Load report details
  async function loadReportDetail(reportId) {
    try {
      const report = await apiCall(`/reports/${reportId}`);
      const analysis = await apiCall(`/analyses/reports/${reportId}/analysis`);
      const findings = await apiCall(`/findings/reports/${reportId}/findings`);
      
      return { report, analysis, findings };
    } catch (error) {
      console.error('Failed to load report detail:', error);
      return null;
    }
  }

  // Show report detail view
  async function showReportDetail(reportId) {
    const data = await loadReportDetail(reportId);
    if (!data) {
      alert('Kon rapport details niet laden');
      return;
    }
    
    const { report, analysis, findings } = data;
    
    // Update the report detail view
    const detailView = document.querySelector('[data-view="Rapportdetail"]');
    if (!detailView) return;
    
    // Update header
    const header = detailView.querySelector('h3');
    if (header) {
      header.textContent = `Rapport ${report.id} ‚Äî ${report.filename}`;
    }
    
    // Update summary
    const summaryElement = document.getElementById('analysis-summary');
    const metaElement = document.getElementById('analysis-meta');
    if (summaryElement) {
      summaryElement.textContent = report.summary || 'Geen samenvatting beschikbaar';
    }
    if (metaElement && analysis) {
      const uploadDate = new Date(report.uploaded_at).toLocaleDateString('nl-NL');
      metaElement.textContent = `Ge√ºpload op ${uploadDate} door ${CURRENT_USER.full} ‚Ä¢ Score: ${analysis.score} ‚Ä¢ Engine: ${analysis.engine} v${analysis.engine_version}`;
    }
    
    // Update findings
    const findingsContainer = document.getElementById('findings-container');
    if (findingsContainer) {
      if (findings.length > 0) {
        const findingsList = document.createElement('ul');
        findings.forEach(finding => {
          const li = document.createElement('li');
          li.style.marginBottom = '8px';
          
          // Severity color
          let severityColor = '#cdd4ea';
          if (finding.severity === 'CRITICAL') severityColor = '#ffb1b1';
          else if (finding.severity === 'HIGH') severityColor = '#ffe28a';
          else if (finding.severity === 'MEDIUM') severityColor = '#b7f7c9';
          
          li.innerHTML = `
            <strong style="color: ${severityColor}">${finding.rule_id} ‚Äî ${finding.section || 'Algemeen'} (${finding.severity}):</strong> 
            ${finding.message}
            ${finding.suggestion ? `<br><em style="color: var(--muted); font-size: 12px;">Suggestion: ${finding.suggestion}</em>` : ''}
          `;
          findingsList.appendChild(li);
        });
        findingsContainer.innerHTML = '';
        findingsContainer.appendChild(findingsList);
      } else {
        findingsContainer.innerHTML = '<p>Geen bevindingen gevonden.</p>';
      }
    }
    
    // Update download button
    const downloadBtn = detailView.querySelector('.btn.primary');
    if (downloadBtn) {
      downloadBtn.onclick = () => downloadConclusion(reportId);
      downloadBtn.disabled = report.status !== 'DONE';
    }
    
    // Add reprocess button if needed
    let reprocessBtn = detailView.querySelector('.btn[onclick*="reprocess"]');
    if (!reprocessBtn && report.status === 'DONE') {
      reprocessBtn = document.createElement('button');
      reprocessBtn.className = 'btn';
      reprocessBtn.textContent = 'Opnieuw analyseren';
      reprocessBtn.onclick = () => reprocessReport(reportId);
      reprocessBtn.style.marginLeft = '8px';
      
      const buttonContainer = detailView.querySelector('.card > div[style*="margin:8px 0 14px"]');
      if (buttonContainer) {
        buttonContainer.appendChild(reprocessBtn);
      }
    }
    
    show('Rapportdetail');
  }

  // Download source file
  async function downloadSource(reportId) {
    try {
      const response = await fetch(`${API_BASE_URL}/reports/${reportId}/source`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('asbest_jwt')}`
        }
      });
      
      if (!response.ok) throw new Error('Download failed');
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `source_${reportId}.pdf`;
      a.click();
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Download failed:', error);
      alert('Download mislukt');
    }
  }

  // Download conclusion file
  async function downloadConclusion(reportId) {
    try {
      const response = await fetch(`${API_BASE_URL}/reports/${reportId}/conclusion`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('asbest_jwt')}`
        }
      });
      
      if (!response.ok) throw new Error('Download failed');
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `conclusie_${reportId}.pdf`;
      a.click();
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Download failed:', error);
      alert('Download mislukt');
    }
  }

  // Reprocess report
  async function reprocessReport(reportId) {
    if (!confirm('Weet je zeker dat je dit rapport opnieuw wilt analyseren?')) {
      return;
    }
    
    try {
      const result = await apiCall(`/reports/${reportId}/reprocess`, {
        method: 'POST'
      });
      
      alert('Rapport wordt opnieuw geanalyseerd. Je wordt doorgestuurd naar de rapportenlijst.');
      show('Rapporten');
      await loadReports(); // Refresh the list
    } catch (error) {
      console.error('Reprocess failed:', error);
      alert('Opnieuw analyseren mislukt');
    }
  }

  // Confirm delete
  function confirmDelete(reportId) {
    if (confirm('Weet je zeker dat je dit rapport wilt verwijderen?')) {
      // TODO: Implement delete functionality
      alert('Verwijderen nog niet ge√Ømplementeerd');
    }
  }

  function show(view){
    document.querySelectorAll('[data-view]').forEach(v=>v.style.display='none');
    document.querySelector(`[data-view="${view}"]`).style.display='block';
    document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
    const link = document.querySelector(`.nav a[data-link="${view}"]`);
    if(link) link.classList.add('active');
    const crumb = document.getElementById('crumb');
    if(crumb) crumb.textContent = `${CURRENT_USER.full} / User / ${view}`;
    
    // Manage auto-refresh based on view
    if (view === 'Rapporten') {
      startAutoRefresh();
    } else {
      stopAutoRefresh();
    }
  }

  // Real file upload functionality
  async function startUpload(file = null) {
    if (!file) {
      // Show file picker
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.pdf,.docx';
      input.onchange = (e) => {
        if (e.target.files[0]) {
          startUpload(e.target.files[0]);
        }
      };
      input.click();
      return;
    }
    
    // Validate file
    if (file.size > 50 * 1024 * 1024) { // 50MB limit
      alert('Bestand is te groot. Maximum 50MB toegestaan.');
      return;
    }
    
    if (!file.name.toLowerCase().endsWith('.pdf') && !file.name.toLowerCase().endsWith('.docx')) {
      alert('Alleen PDF en DOCX bestanden zijn toegestaan.');
      return;
    }
    
    const bar = document.querySelector('.bar');
    const errorDiv = document.getElementById('upload-error');
    if (errorDiv) errorDiv.style.display = 'none';
    
    // Show progress
    bar.style.width = '0%';
    
    try {
      const formData = new FormData();
      formData.append('file', file);
      
      const response = await fetch(`${API_BASE_URL}/reports/`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('asbest_jwt')}`
        },
        body: formData
      });
      
      if (!response.ok) {
        throw new Error(`Upload failed: ${response.status}`);
      }
      
      const result = await response.json();
      
      // Simulate progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 10;
        bar.style.width = progress + '%';
        
        if (progress >= 100) {
          clearInterval(progressInterval);
          alert(`Upload succesvol ‚Äî rapport aangemaakt (${result.id})`);
          show('Rapporten');
          loadReports(); // Refresh the list
        }
      }, 100);
      
    } catch (error) {
      console.error('Upload failed:', error);
      bar.style.width = '0%';
      if (errorDiv) errorDiv.style.display = 'block';
    }
  }

  // Legacy function for testing
  function startUploadTest(success = true) {
    const bar = document.querySelector('.bar');
    let w = 0;
    bar.style.width = '0%';
    const id = setInterval(() => {
      w += 12;
      bar.style.width = w + '%';
      if (w >= 100) {
        clearInterval(id);
        if (success) {
          alert('Upload succesvol ‚Äî rapport aangemaakt (#RPT-2025-0042)');
          show('Rapporten');
        } else {
          document.getElementById('upload-error').style.display = 'block';
        }
      }
    }, 200);
  }

  function confirmDelete(){
    if(confirm('Weet je zeker dat je dit rapport wilt verwijderen?')){
      alert('Rapport verwijderd');
    }
  }

  // Logout functionaliteit
  function logout() {
    localStorage.removeItem('asbest_jwt');
    window.location.href = '/auth';
  }

  // Auto-logout na 30 minuten
  let logoutTimer;
  function resetLogoutTimer(){
    clearTimeout(logoutTimer);
    logoutTimer=setTimeout(()=>{
      alert('Je bent automatisch uitgelogd na 30 minuten inactiviteit');
      logout();
    },1800000);
  }
  ['click','mousemove','keypress'].forEach(evt=>document.addEventListener(evt,resetLogoutTimer));
  
  // Auth check
  function checkAuth() {
    const token = localStorage.getItem('asbest_jwt');
    if (!token) {
      window.location.href = '/auth';
      return false;
    }
    return true;
  }

  // Slice 6: Server-Sent Events for real-time updates
  let eventSource = null;
  let reportsData = [];
  
  function startSSEConnection() {
    if (eventSource) {
      eventSource.close();
    }
    
    const token = localStorage.getItem('asbest_jwt');
    if (!token) {
      console.warn('No auth token available for SSE connection');
      return;
    }
    
    // Create SSE connection with authentication
    eventSource = new EventSource(`${API_BASE_URL}/reports/stream`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    eventSource.onopen = function(event) {
      console.log('‚úÖ SSE connection established');
      showConnectionStatus('connected');
    };
    
    eventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        handleSSEMessage(data);
      } catch (error) {
        console.error('Error parsing SSE message:', error);
      }
    };
    
    eventSource.onerror = function(event) {
      console.error('‚ùå SSE connection error:', event);
      showConnectionStatus('disconnected');
      
      // Attempt to reconnect after 5 seconds
      setTimeout(() => {
        if (eventSource && eventSource.readyState === EventSource.CLOSED) {
          console.log('üîÑ Attempting to reconnect SSE...');
          startSSEConnection();
        }
      }, 5000);
    };
  }
  
  function stopSSEConnection() {
    if (eventSource) {
      eventSource.close();
      eventSource = null;
      showConnectionStatus('disconnected');
    }
  }
  
  function handleSSEMessage(data) {
    switch (data.type) {
      case 'connected':
        console.log('SSE:', data.message);
        break;
        
      case 'initial_state':
        reportsData = data.reports || [];
        updateReportsTableFromSSE(reportsData);
        break;
        
      case 'report_update':
        updateSingleReport(data.report);
        showToast(`Rapport "${data.report.filename}" is ${data.report.status}`, 
                  data.report.status === 'DONE' ? 'success' : 
                  data.report.status === 'FAILED' ? 'error' : 'info');
        
        // Update findings panel if open for this report
        onReportSseUpdate(data);
        break;
        
      case 'heartbeat':
        // Connection is alive
        break;
        
      case 'error':
        console.error('SSE Error:', data.message);
        showToast('Verbindingsfout met server', 'error');
        break;
        
      default:
        console.log('Unknown SSE message type:', data.type);
    }
  }
  
  function updateSingleReport(updatedReport) {
    // Find and update the report in our data
    const index = reportsData.findIndex(r => r.id === updatedReport.id);
    if (index !== -1) {
      reportsData[index] = updatedReport;
    } else {
      reportsData.push(updatedReport);
    }
    
    // Update the UI
    updateReportsTableFromSSE(reportsData);
  }
  
  function updateReportsTableFromSSE(reports) {
    const tbody = document.querySelector('table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    reports.forEach(report => {
      const statusChip = `<span class="chip ${getStatusClass(report.status)}">${report.status}</span>`;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><a onclick="showReportDetail('${report.id}')">${report.filename || 'Onbekend'}</a></td>
        <td>${statusChip}</td>
        <td>${report.finding_count || '‚Äî'}</td>
        <td>${formatDate(report.updated_at)}</td>
        <td>
          <button class="icon-btn" title="Bekijk" onclick="showReportDetail('${report.id}')">üëÅ</button>
          <button class="icon-btn" title="Findings Details" onclick="openFindingsPanel('${report.id}')" ${report.status !== 'DONE' ? 'disabled' : ''}>üîç</button>
          <button class="icon-btn" title="Download rapport" onclick="downloadReport('${report.id}')">‚¨áÔ∏è</button>
          <button class="icon-btn" title="Download conclusie & aanbevelingen (PDF)" onclick="downloadConclusion('${report.id}')" ${report.status !== 'DONE' ? 'disabled' : ''}>üìù</button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  }
  
  function showConnectionStatus(status) {
    // Add visual indicator for connection status
    let indicator = document.getElementById('connection-indicator');
    if (!indicator) {
      indicator = document.createElement('div');
      indicator.id = 'connection-indicator';
      indicator.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        z-index: 1000;
        transition: all 0.3s ease;
      `;
      document.body.appendChild(indicator);
    }
    
    if (status === 'connected') {
      indicator.textContent = 'üü¢ Live';
      indicator.style.background = '#28a745';
      indicator.style.color = 'white';
    } else {
      indicator.textContent = 'üî¥ Offline';
      indicator.style.background = '#dc3545';
      indicator.style.color = 'white';
    }
  }
  
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1001;
      animation: slideIn 0.3s ease;
    `;
    
    switch (type) {
      case 'success':
        toast.style.background = '#28a745';
        break;
      case 'error':
        toast.style.background = '#dc3545';
        break;
      default:
        toast.style.background = '#17a2b8';
    }
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }

  // Slice 6: Download functionality
  async function downloadReport(reportId) {
    try {
      const response = await apiCall(`/reports/${reportId}/download`);
      
      if (response.url) {
        // Open download URL in new tab
        window.open(response.url, '_blank');
        showToast(`Download gestart voor ${response.filename}`, 'success');
      } else {
        throw new Error('No download URL received');
      }
    } catch (error) {
      console.error('Download failed:', error);
      showToast('Download mislukt: ' + (error.message || 'Onbekende fout'), 'error');
    }
  }
  
  // Initialize app
  window.onload=async ()=>{
    // Check authentication first
    if (!checkAuth()) return;
    
    resetLogoutTimer();
    
    // Check API health on startup
    const apiHealthy = await checkApiHealth();
    if (!apiHealthy) {
      console.warn('API is not healthy - some features may not work');
    }
    
    // Start SSE connection for real-time updates
    startSSEConnection();
    
    // Load initial data (fallback if SSE fails)
    await loadReports();
    
    show('Rapporten');
  };
  
  // Clean up SSE connection when page unloads
  window.onbeforeunload = function() {
    stopSSEConnection();
  };

  // Findings Panel Functionality
  let currentFindings = [];
  let currentReportId = null;

  async function openFindingsPanel(reportId) {
    currentReportId = reportId;
    document.getElementById('findings-panel').style.display = 'block';
    document.getElementById('findings-report-id').textContent = reportId;

    try {
      const response = await apiCall(`/reports/${reportId}/findings`);
      currentFindings = response.findings || [];

      document.getElementById('findings-score').textContent = `Score: ${response.score ?? '‚Äî'}`;

      const agg = response.agg?.by_severity || {LOW:0,MEDIUM:0,HIGH:0,CRITICAL:0};
      document.getElementById('count-ALL').textContent = response.agg?.total ?? currentFindings.length;
      document.getElementById('count-LOW').textContent = agg.LOW || 0;
      document.getElementById('count-MEDIUM').textContent = agg.MEDIUM || 0;
      document.getElementById('count-HIGH').textContent = agg.HIGH || 0;
      document.getElementById('count-CRITICAL').textContent = agg.CRITICAL || 0;

      // reset filters
      document.querySelectorAll('.severity-chip').forEach(c => c.classList.remove('active'));
      document.querySelector('.severity-chip[data-severity="ALL"]').classList.add('active');
      document.getElementById('findings-search').value = '';

      renderFindings(currentFindings);
    } catch (err) {
      console.error(err);
      showToast('Kon findings niet laden', 'error');
    }
  }

  function closeFindingsPanel() {
    document.getElementById('findings-panel').style.display = 'none';
    currentFindings = [];
    currentReportId = null;
  }

  function renderFindings(findings) {
    const tbody = document.getElementById('findings-tbody');
    tbody.innerHTML = '';
    findings.forEach(f => {
      const tr = document.createElement('tr');
      tr.setAttribute('data-testid', 'finding-row');
      tr.innerHTML = `
        <td><span class="severity-badge ${sevClass(f.severity)}" data-testid="severity-badge">${f.severity}</span></td>
        <td>${escapeHtml(f.code || '')}</td>
        <td>${escapeHtml(f.message || '')}</td>
        <td title="${escapeHtml(f.evidence || '')}" style="max-width:220px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;">
          ${escapeHtml(f.evidence || '‚Äî')}
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function filterBySeverity(severity) {
    document.querySelectorAll('.severity-chip').forEach(ch => ch.classList.remove('active'));
    document.querySelector(`.severity-chip[data-severity="${severity}"]`).classList.add('active');

    let filtered = currentFindings.slice();
    if (severity !== 'ALL') filtered = filtered.filter(f => f.severity === severity);

    const q = document.getElementById('findings-search').value.toLowerCase();
    if (q) filtered = filtered.filter(f =>
      (f.message || '').toLowerCase().includes(q) || (f.evidence || '').toLowerCase().includes(q)
    );

    renderFindings(filtered);
  }

  function filterFindings() {
    const active = document.querySelector('.severity-chip.active')?.dataset.severity || 'ALL';
    filterBySeverity(active);
  }

  // Hook voor SSE updates
  async function onReportSseUpdate(update) {
    if (!update || !update.report) return;
    if (currentReportId && update.report.id === currentReportId && update.report.status === 'DONE') {
      try {
        const response = await apiCall(`/reports/${currentReportId}/findings`);
        currentFindings = response.findings || [];
        document.getElementById('findings-score').textContent = `Score: ${response.score ?? '‚Äî'}`;
        renderFindings(currentFindings);
        showToast('Findings bijgewerkt', 'info');
      } catch (e) {
        console.error(e);
      }
    }
  }

  function sevClass(sev) {
    switch ((sev || '').toUpperCase()) {
      case 'LOW': return 'severity-low';
      case 'MEDIUM': return 'severity-medium';
      case 'HIGH': return 'severity-high';
      case 'CRITICAL': return 'severity-critical';
      default: return '';
    }
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }
</script>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div><strong>Asbest Tool</strong></div>
        <div class="tenant">Tenant: Bedrijf Y</div>
      </div>
    </div>
    <nav class="nav">
      <a href="#" data-link="Rapporten" onclick="show('Rapporten')">Rapporten</a>
      <a href="#" data-link="Profiel" onclick="show('Profiel')">Profiel</a>
    </nav>
  </aside>

  <main class="content">
    <div class="topbar">
      <div class="crumbs" id="crumb">User</div>
      <div>
        <button class="btn ghost">Help</button>
        <button class="btn" onclick="logout()">Uitloggen</button>
      </div>
    </div>

    <!-- RAPPORTEN -->
    <section data-view="Rapporten">
      <div class="card">
        <h3>Upload nieuw rapport</h3>
        <div class="uploader" onclick="startUpload()" style="cursor: pointer;">
          <p><strong>Sleep je PDF/DOCX hierheen</strong> of tik om te kiezen</p>
          <p class="muted">Max 50 MB ‚Ä¢ Toegestaan: .pdf, .docx</p>
          <button class="btn primary" onclick="event.stopPropagation(); startUpload()">Bestand kiezen</button>
          <button class="btn" onclick="event.stopPropagation(); startUploadTest(false)">Simuleer fout</button>
          <div class="progress"><div class="bar"></div></div>
          <div id="upload-error" style="display:none;margin-top:10px;color:#ffb1b1">
            Upload mislukt. <button class="btn" onclick="startUpload()">Opnieuw proberen</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Rapporten</h3>
        <table>
          <thead>
            <tr><th>Bestandsnaam (project)</th><th>Status</th><th>#Findings</th><th>Score</th><th>Uploaddatum</th><th>Acties</th></tr>
          </thead>
          <tbody>
            <!-- Reports will be loaded dynamically -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- RAPPORTDETAIL -->
    <section data-view="Rapportdetail" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <h3>Rapport RPT-2025-0041 ‚Äî project-123_Kade-12-Amsterdam.pdf</h3>
          <button class="btn" onclick="show('Rapporten')">‚Üê Terug naar rapporten</button>
        </div>

        <div style="margin:8px 0 14px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary">Download conclusie & aanbevelingen (PDF)</button>
        </div>

        <div class="card" style="background:#0d1224">
          <h3>Analyse Samenvatting</h3>
          <p id="analysis-summary">Laden...</p>
          <p class="muted" id="analysis-meta">Laden...</p>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Bevindingen</h3>
          <div id="findings-container">
            <p>Laden...</p>
          </div>
          <p class="muted">*De volledige onderbouwing is opgenomen in de PDF "Conclusie & aanbevelingen".*</p>
        </div>
      </div>
    </section>

    <!-- PROFIEL -->
    <section data-view="Profiel" style="display:none">
      <div class="card">
        <h3>Mijn profiel</h3>
        <div class="grid">
          <div>
            <label class="muted">Voornaam</label>
            <input type="text" value="S."/>
          </div>
          <div>
            <label class="muted">Achternaam</label>
            <input type="text" value="Jansen"/>
          </div>
          <div>
            <label class="muted">Email</label>
            <input type="email" value="s.jansen@bedrijf-y.nl"/>
          </div>
          <div>
            <label class="muted">Tenant</label>
            <input type="text" value="Bedrijf Y" disabled/>
          </div>
        </div>
        <div style="margin-top:12px">
          <button class="btn primary">Opslaan</button>
          <button class="btn">Wachtwoord wijzigen</button>
        </div>
      </div>
    </section>

  </main>

  <!-- Findings Panel Drawer -->
  <div id="findings-panel" class="findings-drawer" style="display:none;">
    <div class="findings-header">
      <div>
        <div class="findings-title">Rapport Details</div>
        <div class="findings-report-id" id="findings-report-id"></div>
      </div>
      <button onclick="closeFindingsPanel()" class="close-btn" aria-label="Close">‚úï</button>
    </div>

    <div class="findings-controls">
      <div data-testid="score-badge" class="score-badge" id="findings-score">Score: ‚Äî</div>
      <input type="text" id="findings-search" placeholder="Zoek in findings..." onkeyup="filterFindings()" class="findings-search">
    </div>

    <div class="severity-filters">
      <button class="severity-chip active" data-severity="ALL" onclick="filterBySeverity('ALL')">
        ALL (<span id="count-ALL">0</span>)
      </button>
      <button class="severity-chip" data-severity="LOW" onclick="filterBySeverity('LOW')" data-testid="severity-chip-LOW">
        LOW (<span id="count-LOW">0</span>)
      </button>
      <button class="severity-chip" data-severity="MEDIUM" onclick="filterBySeverity('MEDIUM')" data-testid="severity-chip-MEDIUM">
        MEDIUM (<span id="count-MEDIUM">0</span>)
      </button>
      <button class="severity-chip" data-severity="HIGH" onclick="filterBySeverity('HIGH')" data-testid="severity-chip-HIGH">
        HIGH (<span id="count-HIGH">0</span>)
      </button>
      <button class="severity-chip" data-severity="CRITICAL" onclick="filterBySeverity('CRITICAL')" data-testid="severity-chip-CRITICAL">
        CRITICAL (<span id="count-CRITICAL">0</span>)
      </button>
    </div>

    <div class="findings-content">
      <table data-testid="findings-table" class="findings-table">
        <thead>
          <tr>
            <th>Severity</th>
            <th>Code</th>
            <th>Message</th>
            <th>Evidence</th>
          </tr>
        </thead>
        <tbody id="findings-tbody"></tbody>
      </table>
    </div>
  </div>
</div>
</body>
</html>
